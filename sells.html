<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <a href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  <title>ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</title>
  <style>
    body {
      font-family: 'Almarai', sans-serif;
      background: url('https://images.pexels.com/photos/13565191/pexels-photo-13565191.jpeg') no-repeat center center fixed;
      background-size: cover;
      color: #000;
      font-weight: bold;
      margin: 0;
      padding: 0;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.9);
      margin: 40px auto;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1b5e20;
    }

    .search-box {
      text-align: center;
      margin-bottom: 15px;
    }

    .search-box input {
      width: 60%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      text-align: center;
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }

    th {
      background-color: #2e7d32;
      color: white;
    }

    input[type="number"],
    select,
    input[type="text"] {
      width: 80%;
      text-align: center;
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #aaa;
      font-weight: bold;
    }

    select {
      background-color: #f8f8f8;
      color: #000;
    }

    .btn {
      display: block;
      background-color: #2e7d32;
      color: white;
      font-weight: bold;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }

    .btn:hover {
      background-color: #1b5e20;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†</h1>

    <div class="info-grid">
      <div>
        <label>ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø¦Ø¹:</label>
        <select id="sellerCode">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ¯ --</option>
        </select>
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
        <input type="text" id="custName">
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
        <input type="text" id="custPhone">
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
        <select id="custCity">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© --</option>
          <option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
          <option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
          <option>Ø§Ù„Ø¬ÙŠØ²Ø©</option>
          <option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
          <option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
          <option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
          <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
          <option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
          <option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
          <option>Ø§Ù„Ù…Ù†ÙŠØ§</option>
          <option>Ø§Ù„ÙÙŠÙˆÙ…</option>
          <option>Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
          <option>Ø¯Ù…ÙŠØ§Ø·</option>
          <option>Ù‚Ù†Ø§</option>
          <option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
          <option>Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
          <option>Ø£Ø³ÙˆØ§Ù†</option>
          <option>Ø£Ø³ÙŠÙˆØ·</option>
          <option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
          <option>Ù…Ø·Ø±ÙˆØ­</option>
          <option>Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
          <option>Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
          <option>Ø³ÙˆÙ‡Ø§Ø¬</option>
          <option>Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
          <option>Ø§Ù„Ø£Ù‚ØµØ±</option>
          <option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
          <option>Ø§Ù„Ø³ÙˆÙŠØ³</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
        <input type="text" id="custAddress">
      </div>
      <div>
        <label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</label>
        <input type="number" id="deposit" value="0">
      </div>
      <div>
        <label>Ø§Ù„Ø´Ø­Ù†:</label>
        <input type="number" id="shipping" value="0">
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</label>
        <input type="text" id="trackingNumber">
      </div>
      <div>
        <label>Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
        <select id="invoiceStatus">
          <option value="Ø¬Ø¯ÙŠØ¯" selected>Ø¬Ø¯ÙŠØ¯</option>
          <option value="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</option>
          <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
          <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
          <option value="Ø­Ø°Ù">Ø­Ø°Ù</option>
        </select>
      </div>
    </div>

    <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ† -->
    <button id="exportInvoicesBtn" class="btn" style="margin-top:10px; width:auto;">ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¥Ù„Ù‰ Excel</button>

    <!-- Ø¨Ø­Ø« Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="search-box">
      <input type="text" id="invoiceSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...">
      <button id="searchInvoiceBtn" class="btn" style="margin-top:10px; width:auto;">Ø¨Ø­Ø«</button>
    </div>

    <!-- Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬...">
    </div>

    <!-- Ø¨Ø­Ø« Ø§Ù„ÙØ¦Ø© -->
    <div class="search-box">
      <input type="text" id="categoryInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ¦Ø©...">
    </div>

    <table id="productTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„ÙØ¦Ø©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn" id="submitOrder">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const BIN_ID = "690874bad0ea881f40d07f5d";
    const ACCESS_KEY = "$2a$10$MUgieOcdv8QNyPRuRsFb6eaAOYcAzxuWL6TB6FbI8L7fhZIVVibdO";
    const API_BASE = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let allProducts = [];
    let adminPhone = '';
    let invoiceCounter = 3000;
    let invoices = [];

    const sellerSelect = document.getElementById("sellerCode");
    const cartQuantities = {};

    for (let i = 1; i <= 20; i++) {
      const code = String(i).padStart(3, '0');
      const option = document.createElement("option");
      option.value = code;
      option.textContent = `Ø¨Ø§Ø¦Ø¹ ${code}`;
      sellerSelect.appendChild(option);
    }

    async function fetchData() {
      try {
        const res = await fetch(`${API_BASE}/latest`, {
          headers: { "X-Master-Key": ACCESS_KEY }
        });
        const data = await res.json();

        allProducts = data.record.products || [];
        adminPhone = data.record.whatsapp || '';
        invoiceCounter = data.record.invoiceCounter && data.record.invoiceCounter >= 3000
          ? data.record.invoiceCounter
          : 3000;
        invoices = data.record.invoices || [];

        renderProducts();
      } catch (err) {
        console.error('Error fetching data', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON.');
      }
    }

    function renderProducts(filterName = '', filterCategory = '') {
      const tbody = document.querySelector("#productTable tbody");
      tbody.innerHTML = "";

      allProducts
        .filter(p => (!filterName || p.name.toLowerCase().includes(filterName.toLowerCase())) &&
          (!filterCategory || p.category.toLowerCase().includes(filterCategory.toLowerCase())))
        .forEach(p => {
          const qty = cartQuantities[p.name] || 0;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.price} Ø¬.Ù…</td>
            <td><input type="number" min="0" value="${qty}" data-name="${p.name}" data-price="${p.price}"></td>
          `;
          tbody.appendChild(row);
        });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§
      tbody.querySelectorAll('input[type="number"][data-name]').forEach(input => {
        input.addEventListener('input', () => {
          const name = input.dataset.name;
          const val = parseInt(input.value) || 0;
          cartQuantities[name] = val;
        });
      });
    }

    document.getElementById("searchInput").addEventListener("input", () => {
      const nameFilter = document.getElementById("searchInput").value;
      const categoryFilter = document.getElementById("categoryInput")?.value || '';
      renderProducts(nameFilter, categoryFilter);
    });

    if (document.getElementById("categoryInput")) {
      document.getElementById("categoryInput").addEventListener("input", () => {
        const nameFilter = document.getElementById("searchInput").value;
        const categoryFilter = document.getElementById("categoryInput").value;
        renderProducts(nameFilter, categoryFilter);
      });
    }

    document.getElementById("submitOrder").addEventListener("click", async () => {
      const sellerCode = sellerSelect.value;
      const custName = document.getElementById('custName').value.trim();
      const custPhone = document.getElementById('custPhone').value.trim();
      const custCity = document.getElementById('custCity').value.trim();
      const custAddress = document.getElementById('custAddress').value.trim();
      const deposit = parseFloat(document.getElementById('deposit').value) || 0;
      const shipping = parseFloat(document.getElementById('shipping').value) || 0;
      const trackingNumber = document.getElementById('trackingNumber').value.trim();
      const invoiceStatus = document.getElementById('invoiceStatus').value;

      if (!sellerCode || !custName || !custPhone || !custCity || !custAddress) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹!");
        return;
      }

      const invoiceItems = [];
      let total = 0;

      for (const [name, qty] of Object.entries(cartQuantities)) {
        if (qty > 0) {
          const product = allProducts.find(p => p.name === name);
          if (product) {
            const price = parseFloat(product.price);
            invoiceItems.push({ name, qty, price, total: qty * price });
            total += qty * price;
          }
        }
      }

      if (invoiceItems.length === 0) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª!");
        return;
      }

      invoiceCounter++;
      const invoiceNumber = invoiceCounter;
      const date = new Date().toLocaleString();
      const finalTotal = total + shipping - deposit;

      const message = encodeURIComponent(
        `ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø§Ø¦Ø¹ ${sellerCode}\nØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceNumber}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n` +
        `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${custName}\nğŸ“ ${custPhone}\nğŸ™ï¸ ${custCity}\nğŸ“ ${custAddress}\n\n` +
        invoiceItems.map(i => `${i.name} x${i.qty} = ${i.total} Ø¬.Ù…`).join("\n") +
        `\n\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬.Ù…\nØ§Ù„Ø´Ø­Ù†: ${shipping} Ø¬.Ù…\nØ§Ù„Ø¹Ø±Ø¨ÙˆÙ†: ${deposit} Ø¬.Ù…\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${finalTotal} Ø¬.Ù…`
      );

      window.open(`https://wa.me/${adminPhone}?text=${message}`, '_blank');

      await sendInvoice({
        number: invoiceNumber,
        date,
        name: custName,
        phone1: custPhone,
        phone2: '',
        sellerCode,
        details: invoiceItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, total: i.total })),
        total: finalTotal,
        notes: '',
        status: invoiceStatus,
        trackingNumber
      });

      // Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      document.getElementById('custName').value = '';
      document.getElementById('custPhone').value = '';
      document.getElementById('custCity').value = '';
      document.getElementById('custAddress').value = '';
      document.getElementById('deposit').value = '';
      document.getElementById('shipping').value = '';
      document.getElementById('trackingNumber').value = '';
      document.getElementById('invoiceStatus').value = 'Ø¬Ø¯ÙŠØ¯';
      for (const key in cartQuantities) cartQuantities[key] = 0;
      renderProducts();
    });

    async function sendInvoice(invoice) {
      invoices.push(invoice);
      const updatedData = {
        products: allProducts,
        invoices: invoices,
        whatsapp: adminPhone,
        invoiceCounter: invoiceCounter
      };

      try {
        const res = await fetch(`${API_BASE}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": ACCESS_KEY
          },
          body: JSON.stringify(updatedData)
        });

        if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ JSON Bin');
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ JSON Bin');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!');
      }
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ
    document.getElementById('searchInvoiceBtn').addEventListener('click', () => {
      const val = document.getElementById('invoiceSearch').value.trim();
      if (!val) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø«");

      const found = invoices.filter(inv =>
        String(inv.number) === val || (inv.phone1 && inv.phone1.includes(val))
      );

      if (found.length === 0) {
        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ');
        return;
      }

      found.forEach(inv => {
        alert(`ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${inv.number}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${inv.name}\nØ§Ù„Ø­Ø§Ù„Ø©: ${inv.status}\nØ±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹: ${inv.trackingNumber || '---'}`);
      });
    });

    // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¥Ù„Ù‰ Excel
    document.addEventListener('DOMContentLoaded', () => {
      const exportInvoicesBtn = document.getElementById('exportInvoicesBtn');
      exportInvoicesBtn.addEventListener('click', async () => {
        if (!invoices.length) { alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§'); return; }

        const sheetData = [
          ['Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ø¨ÙŠØ§Ù†', 'Ø§Ù„ÙƒÙ…ÙŠØ©', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'Ø§Ù„Ø¨Ø§Ø¦Ø¹', 'ØªÙ„ÙŠÙÙˆÙ†1', 'ØªÙ„ÙŠÙÙˆÙ†2', 'Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ø´Ø­Ù†', 'Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†']
        ];

        invoices.forEach(inv => {
          sheetData.push([
            inv.number || '',
            inv.date || '',
            inv.name || '',
            inv.details.map(d => d.name).join(', ') || '',
            inv.details.map(d => d.qty).join(', ') || '',
            inv.details.map(d => d.price).join(', ') || '',
            inv.total || '',
            inv.notes || '',
            inv.sellerCode || '',
            inv.phone1 || '',
            inv.phone2 || '',
            inv.trackingNumber || '',
            inv.status || '',
            inv.clientCode || '',
            inv.shipping || '',
            inv.deposit || ''
          ]);
        });

        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Invoices');

        const fileName = `ÙÙˆØ§ØªÙŠØ±_BAEBIN_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(workbook, fileName);
        alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
      });
    });

    fetchData();
  </script>


</body>

</html>